#!/bin/bash
set -euo pipefail

#######################################
# Pre-push Hook
#######################################
#
# This hook runs Terraform validation before pushing
# to prevent security issues and configuration errors
# from reaching the remote repository.
#
# Runs: ./scripts/validate.sh [layer] [environment]
#######################################

# Get the script directory and project root
HOOK_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${HOOK_DIR}/../.." && pwd)"
VALIDATE_SCRIPT="${PROJECT_ROOT}/scripts/validate.sh"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}üöÄ Running pre-push validation...${NC}"

# Check if validate script exists
if [[ ! -f "$VALIDATE_SCRIPT" ]]; then
  echo -e "${RED}‚ùå Error: Validation script not found: ${VALIDATE_SCRIPT}${NC}"
  exit 1
fi

# Check for secrets in entire repository
echo -e "${BLUE}üîê Scanning entire repository for secrets...${NC}"

if ! command -v gitleaks &>/dev/null; then
  echo -e "${YELLOW}‚ö†Ô∏è  gitleaks not found, skipping secret scan${NC}"
else
  # Check current branch for any secrets - block if any found
  if ! gitleaks detect --config "${PROJECT_ROOT}/scripts/gitleaks-config.toml" --log-opts="--first-parent --branches=$(git rev-parse --abbrev-ref HEAD)" >/dev/null 2>&1; then
    echo -e "${RED}‚ùå BLOCKED: Secrets detected in repository${NC}"
    echo -e "${YELLOW}üí° To bypass (emergency only): git push --no-verify${NC}"
    exit 1
  else
    echo -e "${GREEN}‚úÖ No secrets detected in repository${NC}"
  fi
fi

# Run Terraform validation (non-blocking when infrastructure not deployed)
VALIDATE_SCRIPT="${PROJECT_ROOT}/scripts/validate.sh"
if [[ -f "$VALIDATE_SCRIPT" ]]; then
  echo -e "${BLUE}üîß Running Terraform validation...${NC}"

  # Get list of layers to validate
  ALL_LAYERS=("bootstrap" "governance" "infrastructure" "data-and-ai" "compute" "applications")
  VALIDATION_FAILED=false

  for layer in "${ALL_LAYERS[@]}"; do
    # Check if layer directory exists
    layer_dir_name=""
    case "$layer" in
      "bootstrap") layer_dir_name="01-bootstrap" ;;
      "governance") layer_dir_name="02-governance" ;;
      "infrastructure") layer_dir_name="03-infrastructure" ;;
      "data-and-ai") layer_dir_name="04-data-and-ai" ;;
      "compute") layer_dir_name="05-compute" ;;
      "applications") layer_dir_name="06-applications" ;;
    esac

    if [[ -d "${PROJECT_ROOT}/${layer_dir_name}/terraform" ]]; then
      echo -e "${YELLOW}üîç Validating layer: ${layer}${NC}"

      # Try sbx environment first, then dev - skip init for lint-only mode
      if "$VALIDATE_SCRIPT" "$layer" "sbx" "true" >/dev/null 2>&1; then
        echo -e "${GREEN}‚úÖ Layer ${layer} (sbx) linting passed${NC}"
      elif "$VALIDATE_SCRIPT" "$layer" "dev" "true" >/dev/null 2>&1; then
        echo -e "${GREEN}‚úÖ Layer ${layer} (dev) linting passed${NC}"
      else
        echo -e "${YELLOW}‚ö†Ô∏è  Layer ${layer} linting issues found${NC}"
        VALIDATION_FAILED=true
      fi
    fi
  done

  if [[ "$VALIDATION_FAILED" == true ]]; then
    echo -e "${YELLOW}‚ö†Ô∏è  Some Terraform validations failed (expected when infrastructure not deployed)${NC}"
    echo -e "${GREEN}‚úÖ Secret scanning passed - push allowed${NC}"
  else
    echo -e "${GREEN}‚úÖ All Terraform validations passed${NC}"
  fi
else
  echo -e "${YELLOW}‚ö†Ô∏è  Validation script not found${NC}"
fi

done

exit 0
