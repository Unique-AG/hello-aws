#!/bin/bash
set -euo pipefail

#######################################
# Pre-commit Hook
#######################################
#
# This hook runs Terraform validation on modified files
# before allowing commits to prevent security issues and
# configuration errors.
#
# Runs: ./scripts/validate.sh [layer] [environment]
#######################################

# Get the script directory and project root
HOOK_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${HOOK_DIR}/../.." && pwd)"
VALIDATE_SCRIPT="${PROJECT_ROOT}/scripts/validate.sh"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}üîç Running pre-commit validation...${NC}"

# Check if validate script exists
if [[ ! -f "$VALIDATE_SCRIPT" ]]; then
  echo -e "${RED}‚ùå Error: Validation script not found: ${VALIDATE_SCRIPT}${NC}"
  exit 1
fi

# Check if secret scanning script exists
SECRET_SCAN_SCRIPT="${PROJECT_ROOT}/scripts/scan-secrets.sh"
if [[ ! -f "$SECRET_SCAN_SCRIPT" ]]; then
  echo -e "${YELLOW}‚ö†Ô∏è  Warning: Secret scanning script not found: ${SECRET_SCAN_SCRIPT}${NC}"
  echo -e "${YELLOW}   Skipping secret scan${NC}"
else
  echo -e "${BLUE}üîê Running secret scan on staged changes...${NC}"

  # Check for secrets in staged files
  if ! command -v gitleaks &>/dev/null; then
    echo -e "${YELLOW}‚ö†Ô∏è  gitleaks not found, skipping secret scan${NC}"
  else
    STAGED_FILES=$(git diff --cached --name-only 2>/dev/null)
    if [[ -n "$STAGED_FILES" ]]; then
      # Check all staged files for any secrets - block if any found
      SECRETS_FOUND=false
      for file in $STAGED_FILES; do
        if [[ -f "$file" ]] && ! gitleaks detect --config "${PROJECT_ROOT}/scripts/gitleaks-config.toml" --pipe < "$file" >/dev/null 2>&1; then
          SECRETS_FOUND=true
          echo -e "${RED}‚ùå BLOCKED: Secrets detected in $file${NC}"
          break
        fi
      done

      if [[ "$SECRETS_FOUND" == true ]]; then
        echo -e "${YELLOW}üí° To bypass (emergency only): git commit --no-verify${NC}"
        exit 1
      else
        echo -e "${GREEN}‚úÖ No secrets detected in staged files${NC}"
      fi
    else
      echo -e "${GREEN}‚úÖ No staged files to scan${NC}"
    fi
  fi
fi

# Function to get layer from terraform directory path
get_layer_from_path() {
  local path="$1"
  case "$path" in
    *"01-bootstrap"*) echo "bootstrap" ;;
    *"02-governance"*) echo "governance" ;;
    *"03-infrastructure"*) echo "infrastructure" ;;
    *"04-data-and-ai"*) echo "data-and-ai" ;;
    *"05-compute"*) echo "compute" ;;
    *"06-applications"*) echo "applications" ;;
    *) echo "" ;;
  esac
}

# Get modified files
MODIFIED_FILES=$(git diff --cached --name-only)

# Find modified terraform directories
set +u  # Temporarily disable nounset for array operations
MODIFIED_LAYERS=()
for file in $MODIFIED_FILES; do
  if [[ "$file" == */terraform/* ]]; then
    # Extract the layer directory (e.g., 01-bootstrap, 02-governance, etc.)
    layer_dir=$(echo "$file" | grep -o '^[0-9][0-9]-[^/]*' || echo "")
    if [[ -n "$layer_dir" ]]; then
      layer=$(get_layer_from_path "$layer_dir")
      if [[ -n "$layer" ]]; then
        # Check if layer is already in array
        layer_found=false
        for existing_layer in "${MODIFIED_LAYERS[@]}"; do
          if [[ "$existing_layer" == "$layer" ]]; then
            layer_found=true
            break
          fi
        done
        if [[ "$layer_found" == false ]]; then
          MODIFIED_LAYERS+=("$layer")
        fi
      fi
    fi
  fi
done
set -u  # Re-enable nounset

# If no terraform files modified, skip validation
if [[ ${#MODIFIED_LAYERS[@]} -eq 0 ]]; then
  echo -e "${GREEN}‚úÖ No Terraform files modified, skipping validation${NC}"
  exit 0
fi

echo -e "${YELLOW}üìã Modified Terraform layers: ${MODIFIED_LAYERS[*]}${NC}"

# Validate each modified layer
VALIDATION_FAILED=false
for layer in "${MODIFIED_LAYERS[@]}"; do
  echo -e "${BLUE}üîç Validating layer: ${layer}${NC}"

  # Try to validate with sbx environment first (most common), fallback to dev (lint-only mode)
  if "$VALIDATE_SCRIPT" "$layer" "sbx" "true" >/dev/null 2>&1; then
    echo -e "${GREEN}‚úÖ Layer ${layer} (sbx) linting passed${NC}"
  elif "$VALIDATE_SCRIPT" "$layer" "dev" "true" >/dev/null 2>&1; then
    echo -e "${GREEN}‚úÖ Layer ${layer} (dev) linting passed${NC}"
  else
    echo -e "${RED}‚ùå Layer ${layer} linting failed${NC}"
    VALIDATION_FAILED=true
  fi
done

if [[ "$VALIDATION_FAILED" == true ]]; then
  echo -e "${RED}‚ùå Pre-commit validation failed. Please fix the issues and try again.${NC}"
  echo -e "${YELLOW}üí° Tip: Run './scripts/validate.sh <layer> <env>' manually to debug${NC}"
  exit 1
fi

echo -e "${GREEN}‚úÖ All pre-commit validations passed!${NC}"
exit 0
