# Database initialization Job for LiteLLM
# Creates the 'litellm' database in Aurora PostgreSQL if it doesn't exist
# Equivalent to azurerm_postgresql_flexible_server_database in Azure

resources:
  - apiVersion: batch/v1
    kind: Job
    metadata:
      name: litellm-db-init
      namespace: unique
      annotations:
        argocd.argoproj.io/hook: PostSync
        argocd.argoproj.io/hook-delete-policy: HookSucceeded
    spec:
      ttlSecondsAfterFinished: 300
      backoffLimit: 3
      template:
        spec:
          restartPolicy: OnFailure
          containers:
            - name: create-db
              image: postgres:14
              command:
                - sh
                - -c
                - |
                  export PGCONNSTR="postgresql://${PGUSER}:${PGPASSWORD}@${PGHOST}:5432/postgres?sslmode=require"
                  psql "$PGCONNSTR" -tc "SELECT 1 FROM pg_database WHERE datname = 'litellm'" | grep -q 1 \
                    && echo "Database 'litellm' already exists" \
                    || psql "$PGCONNSTR" -c "CREATE DATABASE litellm"
              env:
                - name: PGHOST
                  valueFrom:
                    secretKeyRef:
                      name: litellm-db-init-secrets
                      key: PGHOST
                - name: PGUSER
                  valueFrom:
                    secretKeyRef:
                      name: litellm-db-init-secrets
                      key: PGUSER
                - name: PGPASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: litellm-db-init-secrets
                      key: PGPASSWORD

  # ExternalSecret to pull Aurora admin credentials for the init Job
  - apiVersion: external-secrets.io/v1beta1
    kind: ExternalSecret
    metadata:
      name: litellm-db-init-secrets
      namespace: unique
    spec:
      refreshInterval: 1h
      secretStoreRef:
        kind: ClusterSecretStore
        name: aws-secrets-manager
      target:
        name: litellm-db-init-secrets
      data:
        - secretKey: PGHOST
          remoteRef:
            key: psql-host
        - secretKey: PGUSER
          remoteRef:
            key: psql-username
        - secretKey: PGPASSWORD
          remoteRef:
            key: psql-password
