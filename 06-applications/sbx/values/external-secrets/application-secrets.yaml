# Application ExternalSecrets for AWS
# Deployed before application workloads to ensure secrets exist
# This is the helmfile equivalent of ArgoCD sync-wave: "-1"

resources:
  # Chat backend service
  - apiVersion: external-secrets.io/v1beta1
    kind: ExternalSecret
    metadata:
      name: chat-secrets
      namespace: unique
    spec:
      refreshInterval: 1h
      secretStoreRef:
        kind: ClusterSecretStore
        name: aws-secrets-manager
      target:
        name: chat-secrets
      data:
        - secretKey: DATABASE_URL
          remoteRef:
            key: psql-connection-string-chat
        - secretKey: PUBSUB_REDIS_HOST
          remoteRef:
            key: redis-host
        - secretKey: PUBSUB_REDIS_PORT
          remoteRef:
            key: redis-port
        - secretKey: CHAT_LXM_ENCRYPTION_KEY
          remoteRef:
            key: encryption-key-node-chat-lxm
        - secretKey: S3_AI_DATA_BUCKET
          remoteRef:
            key: s3-ai-data-bucket
        - secretKey: S3_APPLICATION_DATA_BUCKET
          remoteRef:
            key: s3-application-data-bucket
        # S3 storage configuration (required by S3BucketStrategy)
        - secretKey: S3_BUCKET_BUCKET_NAME
          remoteRef:
            key: s3-application-data-bucket
        - secretKey: S3_BUCKET_ENDPOINT
          remoteRef:
            key: s3-endpoint
        - secretKey: S3_BUCKET_REGION
          remoteRef:
            key: s3-region
        - secretKey: S3_BUCKET_ACCESS_KEY
          remoteRef:
            key: s3-access-key-id
        - secretKey: S3_BUCKET_SECRET_ACCESS_KEY
          remoteRef:
            key: s3-secret-access-key
        - secretKey: LITELLM_API_KEY
          remoteRef:
            key: litellm-proxy-master-key
        - secretKey: AZURE_OPENAI_API_ENDPOINTS_JSON
          remoteRef:
            key: azure-openai-endpoint-definitions

  # App Repository backend service
  - apiVersion: external-secrets.io/v1beta1
    kind: ExternalSecret
    metadata:
      name: app-repository-secrets
      namespace: unique
    spec:
      refreshInterval: 1h
      secretStoreRef:
        kind: ClusterSecretStore
        name: aws-secrets-manager
      target:
        name: app-repository-secrets
      data:
        - secretKey: DATABASE_URL
          remoteRef:
            key: psql-connection-string-app-repository
        - secretKey: ENCRYPTION_KEY
          remoteRef:
            key: encryption-key-app-repository

  # Scope Management backend service
  - apiVersion: external-secrets.io/v1beta1
    kind: ExternalSecret
    metadata:
      name: scope-management-secrets
      namespace: unique
    spec:
      refreshInterval: 1h
      secretStoreRef:
        kind: ClusterSecretStore
        name: aws-secrets-manager
      target:
        name: scope-management-secrets
      data:
        - secretKey: DATABASE_URL
          remoteRef:
            key: psql-connection-string-scope-management
        - secretKey: ZITADEL_PAT
          remoteRef:
            key: manual-zitadel-scope-mgmt-pat

  # Configuration (theme) backend service
  - apiVersion: external-secrets.io/v1beta1
    kind: ExternalSecret
    metadata:
      name: configuration-secrets
      namespace: unique
    spec:
      refreshInterval: 1h
      secretStoreRef:
        kind: ClusterSecretStore
        name: aws-secrets-manager
      target:
        name: configuration-secrets
      data:
        - secretKey: DATABASE_URL
          remoteRef:
            key: psql-connection-string-theme

  # Ingestion backend service
  - apiVersion: external-secrets.io/v1beta1
    kind: ExternalSecret
    metadata:
      name: ingestion-secrets
      namespace: unique
    spec:
      refreshInterval: 1h
      secretStoreRef:
        kind: ClusterSecretStore
        name: aws-secrets-manager
      target:
        name: ingestion-secrets
      data:
        - secretKey: DATABASE_URL
          remoteRef:
            key: psql-connection-string-ingestion
        - secretKey: ENCRYPTION_KEY
          remoteRef:
            key: encryption-key-ingestion
        - secretKey: INGESTION_ENCRYPTION_KEY
          remoteRef:
            key: encryption-key-ingestion
        - secretKey: S3_BUCKET_BUCKET_NAME
          remoteRef:
            key: s3-application-data-bucket
        - secretKey: S3_BUCKET_ENDPOINT
          remoteRef:
            key: s3-endpoint
        - secretKey: S3_BUCKET_REGION
          remoteRef:
            key: s3-region
        - secretKey: S3_BUCKET_ACCESS_KEY
          remoteRef:
            key: s3-access-key-id
        - secretKey: S3_BUCKET_SECRET_ACCESS_KEY
          remoteRef:
            key: s3-secret-access-key
        - secretKey: S3_APPLICATION_DATA_BUCKET
          remoteRef:
            key: s3-application-data-bucket
        - secretKey: AZURE_OPENAI_API_KEY
          remoteRef:
            key: litellm-proxy-master-key

  # Ingestion Worker backend service
  - apiVersion: external-secrets.io/v1beta1
    kind: ExternalSecret
    metadata:
      name: ingestion-worker-secrets
      namespace: unique
    spec:
      refreshInterval: 1h
      secretStoreRef:
        kind: ClusterSecretStore
        name: aws-secrets-manager
      target:
        name: ingestion-worker-secrets
      data:
        - secretKey: DATABASE_URL
          remoteRef:
            key: psql-connection-string-ingestion
        - secretKey: S3_BUCKET_BUCKET_NAME
          remoteRef:
            key: s3-application-data-bucket
        - secretKey: S3_BUCKET_ENDPOINT
          remoteRef:
            key: s3-endpoint
        - secretKey: S3_BUCKET_REGION
          remoteRef:
            key: s3-region
        - secretKey: S3_BUCKET_ACCESS_KEY
          remoteRef:
            key: s3-access-key-id
        - secretKey: S3_BUCKET_SECRET_ACCESS_KEY
          remoteRef:
            key: s3-secret-access-key
        - secretKey: S3_APPLICATION_DATA_BUCKET
          remoteRef:
            key: s3-application-data-bucket
        - secretKey: AZURE_OPENAI_API_KEY
          remoteRef:
            key: litellm-proxy-master-key

  # Webhook Scheduler backend service
  - apiVersion: external-secrets.io/v1beta1
    kind: ExternalSecret
    metadata:
      name: webhook-scheduler-secrets
      namespace: unique
    spec:
      refreshInterval: 1h
      secretStoreRef:
        kind: ClusterSecretStore
        name: aws-secrets-manager
      target:
        name: webhook-scheduler-secrets
      data:
        - secretKey: DATABASE_URL
          remoteRef:
            key: psql-connection-string-chat

  # Webhook Worker backend service
  - apiVersion: external-secrets.io/v1beta1
    kind: ExternalSecret
    metadata:
      name: webhook-worker-secrets
      namespace: unique
    spec:
      refreshInterval: 1h
      secretStoreRef:
        kind: ClusterSecretStore
        name: aws-secrets-manager
      target:
        name: webhook-worker-secrets
      data:
        - secretKey: DATABASE_URL
          remoteRef:
            key: psql-connection-string-chat

  # Assistants Core AI service
  - apiVersion: external-secrets.io/v1beta1
    kind: ExternalSecret
    metadata:
      name: assistants-core-secrets
      namespace: unique
    spec:
      refreshInterval: 1h
      secretStoreRef:
        kind: ClusterSecretStore
        name: aws-secrets-manager
      target:
        name: assistants-core-secrets
      data:
        - secretKey: S3_AI_DATA_BUCKET
          remoteRef:
            key: s3-ai-data-bucket
        - secretKey: S3_APPLICATION_DATA_BUCKET
          remoteRef:
            key: s3-application-data-bucket

  # Docling Ingestor service
  - apiVersion: external-secrets.io/v1beta1
    kind: ExternalSecret
    metadata:
      name: ingestor-secrets
      namespace: unique
    spec:
      refreshInterval: 1h
      secretStoreRef:
        kind: ClusterSecretStore
        name: aws-secrets-manager
      target:
        name: ingestor-secrets
      data:
        - secretKey: REDIS_HOST
          remoteRef:
            key: redis-host

  # LiteLLM proxy
  - apiVersion: external-secrets.io/v1beta1
    kind: ExternalSecret
    metadata:
      name: litellm
      namespace: unique
    spec:
      refreshInterval: 1h
      secretStoreRef:
        kind: ClusterSecretStore
        name: aws-secrets-manager
      target:
        name: litellm
      data:
        - secretKey: DATABASE_URL
          remoteRef:
            key: psql-connection-string-litellm
        - secretKey: PROXY_MASTER_KEY
          remoteRef:
            key: litellm-proxy-master-key
        - secretKey: LITELLM_SALT_KEY
          remoteRef:
            key: litellm-salt-key
